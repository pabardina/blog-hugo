<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Docker : Django, Gunicorn, Celery, Redis, PostgreSQL &middot; Pierre-Alexandre Bardina</title>

  
  <link rel="stylesheet" href="http://localhost:1313/css/poole.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde.css">
  <link rel="stylesheet" href="http://localhost:1313/css/poole-overrides.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde-overrides.css">
  <link rel="stylesheet" href="http://localhost:1313/css/hyde-x.css">
  <link rel="stylesheet" href="http://localhost:1313/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:1313/touch-icon-144-precomposed.png">
  <link href="http://localhost:1313/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Pierre-Alexandre Bardina</h1>
      <p class="lead">En perpétuelle évolution</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="http://localhost:1313/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/pabardina"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      <a href="https://www.linkedin.com/in/pabardina"><i class="fa fa-linkedin-square fa-3x"></i></a>
      
      
      <a href="https://www.twitter.com/pabardina"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2015 <a href="http://localhost:1313/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>Docker : Django, Gunicorn, Celery, Redis, PostgreSQL</h1>
    <span class="post-date">May 20, 2015 &middot; 4 minute read
    </span>
    

<p>Développement Django avec Docker Compose.
La stack utilisée pour l&rsquo;exemple :</p>

<ul>
<li>Django</li>
<li>PostgreSQL</li>
<li>Gunicorn</li>
<li>Celery</li>
<li>Nginx</li>
<li>Redis</li>
<li>Supervisor</li>
</ul>

<p><a href="https://github.com/pabardina/docker-compose-django">Git du projet </a></p>

<h2 id="docker:48b80581519ee5b4f1eaab835a4ece73">Docker ?</h2>

<blockquote>
<p>Docker est un outil qui peut empaqueter une application et ses dépendances dans un conteneur virtuel, qui pourra être exécuté sur n&rsquo;importe quel serveur Linux.<br />
<a href="https://www.docker.com">Docker</a> (documentation officielle)<br />
<a href="http://www.it-wars.com/debuter-avec-docker/">Débuter avec Docker</a></p>
</blockquote>

<p><img src="/images/2015/05/big-docker-logo-300x267.png" alt="" /></p>

<p><br/></p>

<h2 id="docker-compose:48b80581519ee5b4f1eaab835a4ece73">Docker Compose</h2>

<blockquote>
<p>Compose est un outil pour définir et exécuter des applications complexes avec Docker. Avec Compose, vous définissez une application multi-conteneur dans un seul fichier, puis tourner votre application en une seule commande qui s&rsquo;occupe de tout pour le faire marcher.<br />
<a href="https://docs.docker.com/compose/">Docker Compose</a></p>
</blockquote>

<p><br/></p>

<h3 id="dockerfile:48b80581519ee5b4f1eaab835a4ece73">Dockerfile</h3>

<p>Le Dockerfile du projet va créer un conteneur avec l&rsquo;application Django,  installer ses dépendances ainsi que gérer Gunicorn et Celery avec Supervisor.</p>

<pre><code>FROM ubuntu:14.10

ENV PYTHONUNBUFFERED 1

WORKDIR /code

RUN apt-get update &amp;&amp; apt-get upgrade -qq
RUN apt-get install -y build-essential git
RUN apt-get install -y python python-dev python-setuptools python-software-properties libpq-dev libxml2 gcc libxslt1-dev vim
RUN apt-get install -y supervisor
RUN apt-get -y autoremove
RUN easy_install pip

RUN mkdir -p /var/log/supervisor /etc/supervisor/conf.d
ADD docker_config/supervisor.conf /etc/supervisor/conf.d/myconf.conf

ADD requirements.txt /code/requirements.txt

RUN pip install -r /code/requirements.txt
</code></pre>

<p><br/></p>

<h3 id="utilisation-d-un-conteneur-de-données:48b80581519ee5b4f1eaab835a4ece73">Utilisation d&rsquo;un conteneur de données</h3>

<p>Un conteneur de données va permettre de stocker des données utilisables par plusieurs conteneurs.<br />
Deux bonnes ressources :</p>

<ul>
<li><a href="https://docs.docker.com/userguide/dockervolumes/#creating-and-mounting-a-data-volume-container">data container</a>  (documentation officielle)</li>
<li><a href="https://medium.com/@ramangupta/why-docker-data-containers-are-good-589b3c6c749e">un bon discours</a></li>
</ul>

<p>Il n&rsquo;est pas possible de créer un container de données avec Compose (bientôt ?).
<br/>Ainsi, pour le créer manuellement :</p>

<p><code>docker create -v /data --name data ubuntu:14.10 /bin/true</code></p>

<p>J&rsquo;utilise ubuntu:14.10, c&rsquo;est une image que j&rsquo;utilise déjà avec un autre conteneur, cela m&rsquo;évite d&rsquo;utiliser de l&rsquo;espace disque pour rien.
Le conteneur de données est utilisé pour stocker le &ldquo;static&rdquo; du projet Django, ainsi que les fichiers de redis (persistance de données pour Celery).
<br/></p>

<h3 id="compose:48b80581519ee5b4f1eaab835a4ece73">COMPOSE</h3>

<p><code>docker-compose.yml</code></p>

<pre><code>db:
  image: jamesbrink/postgresql
  environment:
    - SCHEMA=example
    - USER=example
    - PASSWORD=password
    - POSTGIS=true

rediscache:
  image: redis:latest

rediscelery:
  image: redis:latest
  volumes_from:
    - data

app:
  build: .
  command: /usr/bin/supervisord -n
  volumes:
    - ./docker_config/supervisor.conf:/etc/supervisor/conf.d/myconf.conf
    - ./docker_config/start.sh:/code/start.sh
    - ./docker_config/start_cel.sh:/code/start_cel.sh
    - ./project:/code
  volumes_from:
    - data
  links:
    - db
    - rediscache
    - rediscelery

nginx:
  image: nginx:latest
  volumes:
    - ./docker_config/myconf.nginx:/etc/nginx/nginx.conf
  volumes_from:
    - data
  ports:
    - &quot;80:80&quot;
  links:
    - app
</code></pre>

<p>Nous avons donc 5 conteneurs dans le fichier (6 avec le conteneur de données créé plus haut)  :</p>

<ul>
<li>app avec :<br />

<ul>
<li>Django</li>
<li>Gunicorn</li>
<li>Celery</li>
</ul></li>
<li>db avec PostgreSQL</li>
<li>Nginx</li>
<li>rediscache pour le cache de Django (sessions&hellip;)</li>
<li>rediscelery broker celery avec persistance de données</li>
</ul>

<h3 id="lancement:48b80581519ee5b4f1eaab835a4ece73">Lancement</h3>

<p>Pour créer les conteneurs :<br />
<code>docker-compose up -d</code> (-d pour lancer en mode détaché)</p>

<p>Pour démarrer les conteneurs déjà créés, il faut utiliser <code>docker-compose start</code>, si vous utilisez <code>up</code>, ils vont se recréer.</p>

<p>Il est possible de vouloir recréer un conteneur spécifique :<br />
<code>docker-compose up --no-deps container_name</code> (&ndash;no-deps signifie que l&rsquo;on ne veut pas recréer les conteneurs liés)
<br/></p>

<h4 id="comment-utiliser-les-conteneurs-entre-eux:48b80581519ee5b4f1eaab835a4ece73">Comment utiliser les conteneurs entre eux ?</h4>

<p>Pour pouvoir utiliser par exemple PostgreSQL ou Redis depuis mon conteneur <code>app</code>, il n&rsquo;y a pas besoin de connaître l&rsquo;ip. On peut utiliser juste le nom du conteneur.
<code>'HOST': 'db'</code> ou <code>BROKER_URL = 'redis://rediscelery:6379/0'</code></p>

<p>En effet, Compose remplit le fichier hosts des conteneurs.</p>

<pre><code>root@a230dcd1741c:/code# cat /etc/hosts
127.0.0.1	localhost
172.17.0.68	rediscelery_1
172.17.0.69	dockercomposeexample_db_1
172.17.0.70	rediscache
172.17.0.70	rediscache_1
172.17.0.68	rediscelery
172.17.0.69	db
172.17.0.69	db_1
172.17.0.70	dockercomposeexample_rediscache_1
172.17.0.68	dockercomposeexample_rediscelery_1
</code></pre>

<p>Il est bien entendu possible d&rsquo;utiliser moins de conteneurs. J&rsquo;ai choisi d&rsquo;avoir deux conteneurs redis parce qu&rsquo;ils ont une configuration différente, choix discutable. Il est également possible d&rsquo;avoir Nginx dans le conteneur &ldquo;app&rdquo;. Néanmoins, si vous voulez utiliser Nginx comme load balancer entre plusieurs conteneurs de votre application, il faut le laisser dans un conteneur à part.
<br/></p>

<h3 id="optimisation:48b80581519ee5b4f1eaab835a4ece73">Optimisation</h3>

<p>Compose gère la plupart des paramètres de Docker. Ainsi, la gestion des ressources se fait via <code>mem_limit</code> pour la mémoire, <code>cpu_shares</code>pour le cpu.</p>

<p>Exemple :</p>

<pre><code>db:
  image: jamesbrink/postgresql
  mem_limit:100m
  cpu_shares:50
</code></pre>

<p><br/></p>

<h3 id="pour-conclure:48b80581519ee5b4f1eaab835a4ece73">Pour conclure</h3>

<p>Pour &ldquo;entrer&rdquo; dans un conteneur et avoir un shell (<a href="http://jpetazzo.github.io/2014/06/23/docker-ssh-considered-evil/">If you run SSHD in your Docker containers, you&rsquo;re doing it wrong!)</a>, la façon la plus simple est de lancer cette commande :<br />
<code>docker exec -it id_container bash</code></p>

<p>Néanmoins, vous trouverez sur ce <a href="http://programster.blogspot.fr/2014/01/docker-enter-running-container.html">site</a>, un petit script pour raccourcir la commande à :<br />
<code>docker-enter idcontainer</code></p>

<p>C&rsquo;est quand même plus cool !</p>

<p><a href="https://github.com/pabardina/docker-compose-django">Git du projet </a></p>

<p>Cet article est susceptible d&rsquo;être modifié au fur et à mesure des mises à jour de Docker, de Compose et des mes expériences.</p>

  </div>
  
</div>




<script src="http://localhost:1313/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

